<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GMAO Planasa ‚Äì Finanzas (Mockup completo)</title>
  <style>
    :root{
      /* Verde PLANASA oficial */
      --brand:#00a651; --brand-2:#008a44; --brand-3:#006633;
      --brand-light:#e8f5f0; --brand-ultra-light:#f4faf7;
      
      /* Fondos mejorados */
      --bg:#fafcfb; --bg-2:#f0f7f3; --muted:#e8f5f0;
      --card:#ffffff; --card-hover:#fcfefd;
      
      /* Textos optimizados */
      --txt:#1a2e23; --txt-2:#4a6b56; --txt-3:#7a8a80;
      
      /* Bordes y sombras mejoradas */
      --border:rgba(0,166,81,.12); --border-light:rgba(0,166,81,.08);
      --shadow:0 4px 20px rgba(0,166,81,.08); 
      --shadow-hover:0 8px 32px rgba(0,166,81,.12);
      --shadow-strong:0 12px 40px rgba(0,0,0,.15);
      
      /* Estados de color */
      --ok:#00a651; --warn:#ff8f00; --crit:#d32f2f; --info:#1976d2;
      --ok-bg:#e8f5e8; --warn-bg:#fff8e1; --crit-bg:#ffebee; --info-bg:#e3f2fd;
    }
    *{box-sizing:border-box} 
    html,body{height:100%}
    body{
      margin:0; padding:0;
      background:linear-gradient(135deg, var(--bg) 0%, var(--bg-2) 50%, var(--brand-ultra-light) 100%);
      color:var(--txt);
      font:15px system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
      line-height:1.5;
      -webkit-font-smoothing:antialiased;
      min-height:100vh;
    }
    a{color:inherit;text-decoration:none}
    
    /* Scrollbar personalizada */
    ::-webkit-scrollbar{width:8px; height:8px}
    ::-webkit-scrollbar-track{background:var(--muted)}
    ::-webkit-scrollbar-thumb{background:var(--brand); border-radius:4px}
    ::-webkit-scrollbar-thumb:hover{background:var(--brand-2)}
    /* Header principal con navbar horizontal */
    header{
      position:sticky; top:0; z-index:10;
      background:linear-gradient(135deg, var(--brand) 0%, var(--brand-2) 50%, var(--brand-3) 100%);
      box-shadow:var(--shadow-strong);
      color:#fff;
      backdrop-filter:blur(10px);
    }
    
    /* Barra superior con logo */
    .top-bar{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:16px 20px; font-weight:900; font-size:18px;
      border-bottom:1px solid rgba(255,255,255,0.1);
    }
    
    .brand-logo{
      display:flex; align-items:center; gap:12px;
      font-size:20px; font-weight:900; letter-spacing:-0.5px;
    }
    
    /* Navbar horizontal mejorada */
    .navbar{
      display:flex; align-items:center; gap:6px; padding:0 20px 16px 20px;
      overflow-x:auto; -webkit-overflow-scrolling:touch;
      scrollbar-width:none; -ms-overflow-style:none;
    }
    .navbar::-webkit-scrollbar{display:none}
    
    .nav-link{
      display:flex; align-items:center; gap:10px;
      padding:10px 18px; border-radius:12px; 
      color:rgba(255,255,255,0.8); text-decoration:none;
      font-weight:600; white-space:nowrap; font-size:14px;
      transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border:1px solid transparent;
      backdrop-filter:blur(4px);
    }
    
    .nav-link:hover{
      background:rgba(255,255,255,0.12);
      color:#fff;
      transform:translateY(-1px);
      box-shadow:0 4px 12px rgba(0,0,0,0.2);
    }
    
    .nav-link.active{
      background:rgba(255,255,255,0.2);
      color:#fff;
      border-color:rgba(255,255,255,0.3);
      box-shadow:0 2px 8px rgba(0,0,0,0.15);
    }
    
    main{padding:0; margin:0}
    .h-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .btn{
      border:1px solid rgba(255,255,255,.25);
      background:rgba(255,255,255,.15);
      color:#fff; padding:10px 16px; border-radius:10px;
      cursor:pointer; font-weight:600; backdrop-filter:blur(8px);
      transition:all 0.2s ease; font-size:14px;
    }
    .btn:hover{
      background:rgba(255,255,255,.25);
      border-color:rgba(255,255,255,.4);
      transform:translateY(-1px);
    }
    .btn:active{transform:scale(.98) translateY(0)}
    
    .logo{
      width:32px; height:32px; border-radius:8px; 
      background:linear-gradient(135deg, #fff 0%, #f0f8f4 100%);
      display:flex; align-items:center; justify-content:center;
      font-weight:900; color:var(--brand); font-size:18px;
      box-shadow:0 2px 8px rgba(0,0,0,0.1);
    }
    .logo::after{content:"P"}
    .content{
      padding:20px;display:grid;gap:20px;
      max-width:1600px; margin:0 auto;
    }
    .panel{background:radial-gradient(120% 120% at 0% 0%, rgba(31,111,61,.06) 0%, transparent 60%), var(--card);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);display:flex;flex-direction:column}
    .panel .head{padding:10px 12px;border-bottom:1px solid var(--border);font-weight:900;display:flex;justify-content:space-between;align-items:center;color:var(--txt-2)}
    .panel .body{padding:12px}
    .tabs{display:grid;grid-template-columns:240px 1fr;gap:12px}
    .tabbar{display:flex;flex-direction:column;gap:10px}
    .tabbtn{display:flex;gap:10px;align-items:center;padding:12px;border-radius:12px;border:1px solid var(--border);background:var(--muted);cursor:pointer;font-weight:900;color:var(--txt)}
    .tabbtn[aria-selected="true"]{background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;border-color:transparent}
    .tab-emoji{font-size:18px}
    .tab-sub{font-size:12px;opacity:.9}
    .tabpanel[hidden]{display:none}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .kpi{background:linear-gradient(180deg,rgba(255,255,255,.35),rgba(255,255,255,.05));border:1px solid var(--border);border-radius:12px;padding:10px;text-align:center}
    .kpi .title{font-size:12px;color:var(--txt-2);font-weight:800}
    .kpi .val{font-size:22px;font-weight:900;color:var(--brand)}
    .grid-2{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .td-right{text-align:right}
    canvas{width:100%;height:260px;border:1px solid var(--border);border-radius:12px;background:var(--card)}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{position:sticky;top:0;background:var(--card);z-index:1;font-size:12px;color:var(--txt-2);text-align:left;padding:6px 8px;border-bottom:1px solid var(--border);cursor:pointer}
    tbody td{padding:8px 10px;background:var(--card);border:1px solid var(--border);font-size:13px}
    tbody td:first-child{border-top-left-radius:10px;border-bottom-left-radius:10px}
    tbody td:last-child{border-top-right-radius:10px;border-bottom-right-radius:10px}
    .badge{padding:6px 10px;border-radius:999px;font-size:12px;font-weight:900}
    .b-warn{background:#fff3cd;color:#7a5d00}
    .b-crit{background:#ffebee;color:#c62828}
    .b-ok{background:#e8f5e9;color:#2e7d32}
    .gap-pos{color:#2e7d32;font-weight:900}
    .gap-neg{color:#c62828;font-weight:900}
    @media (max-width:1200px){
      .tabs{grid-template-columns:1fr}
      .kpis{grid-template-columns:repeat(2,1fr)}
      .grid-2{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <main>
    <header>
      <!-- Barra superior -->
      <div class="top-bar">
        <div class="brand-logo">
          <div class="logo"></div>
          <span>GMAO Planasa</span>
        </div>
        <div class="h-actions">
          <button id="exportCSV" class="btn">‚¨áÔ∏è Exportar CSV</button>
          <button id="exportRates" class="btn">‚¨áÔ∏è Exportar Tarifas</button>
        </div>
      </div>
      
      <!-- Navbar horizontal -->
      <nav class="navbar" role="navigation" aria-label="Men√∫ principal">
        <a class="nav-link" href="Web/Inicio.html">üìä Inicio</a>
        <a class="nav-link" href="Web/GMO.html">üìÖ Gesti√≥n MO</a>
        <a class="nav-link" href="Web/Maquinaria.html">üõ†Ô∏è Maquinaria</a>
        <a class="nav-link active" href="Web/Finanzas.html">üí∂ Finanzas</a>
      </nav>
    </header>

    <div class="content">
      <div class="panel">
        <div class="head">
          <span class="badge b-ok">A√±o: <span id="yearLbl"></span></span>
          <div class="toolbar">
            <select id="periodo" class="btn">
              <option value="mes">Este mes</option>
              <option value="trim">Este trimestre</option>
              <option value="anio">Este a√±o</option>
            </select>
          </div>
        </div>

        <div class="body">
          <div class="tabs" aria-label="M√≥dulos de finanzas">
            <div class="tabbar" role="tablist" aria-orientation="vertical">
              <button id="tab-activos" class="tabbtn" role="tab" aria-selected="true" aria-controls="panel-activos" data-target="activos"><span class="tab-emoji">üè∑Ô∏è</span><div><div>Activos Fijos</div><div class="tab-sub">Contabilidad ‚Üî Mantenimiento</div></div></button>
              <button id="tab-opex" class="tabbtn" role="tab" aria-selected="false" aria-controls="panel-opex" data-target="opex"><span class="tab-emoji">üí∞</span><div><div>OPEX</div><div class="tab-sub">Repuestos, MO, paradas</div></div></button>
              <button id="tab-capex" class="tabbtn" role="tab" aria-selected="false" aria-controls="panel-capex" data-target="capex"><span class="tab-emoji">üìä</span><div><div>CAPEX & Forecast</div><div class="tab-sub">Planificaci√≥n y CFO</div></div></button>
              <button id="tab-rates" class="tabbtn" role="tab" aria-selected="false" aria-controls="panel-rates" data-target="rates"><span class="tab-emoji">üí∂</span><div><div>Tarifas & GAP</div><div class="tab-sub">Rate/h interno vs mercado</div></div></button>
            </div>

            <div>
              <!-- ===== ACTIVOS ===== -->
              <section id="panel-activos" class="tabpanel" role="tabpanel" aria-labelledby="tab-activos">
                <div class="kpis">
                  <div class="kpi"><div class="title">N¬∫ de activos</div><div class="val" id="kpiActivos">‚Äî</div><div class="small">Total en registro</div></div>
                  <div class="kpi"><div class="title">Valor neto</div><div class="val" id="kpiValorNeto">‚Äî ‚Ç¨</div><div class="small">Coste ‚Äì amortizaci√≥n</div></div>
                  <div class="kpi"><div class="title">Edad media</div><div class="val" id="kpiEdad">‚Äî</div><div class="small">Vida √∫til consumida</div></div>
                </div>

                <div class="grid-2" style="margin-top:12px">
                  <div>
                    <div class="toolbar" style="justify-content:space-between;margin-bottom:6px"><strong>Valor neto por centro de coste</strong></div>
                    <canvas id="chActivosByCC"></canvas>
                  </div>
                  <div>
                    <div class="toolbar" style="justify-content:space-between;margin-bottom:6px"><strong>% Vida √∫til consumida (Top 5)</strong></div>
                    <canvas id="chVidaConsumida"></canvas>
                  </div>
                </div>

                <div class="panel" style="margin-top:12px">
                  <div class="head"><span>Registro de Activos</span><input id="searchActivos" placeholder="Buscar c√≥digo/descr." class="btn" style="padding:8px 10px"/></div>
                  <div class="body">
                    <table>
                      <thead>
                        <tr>
                          <th>C√≥digo contable</th><th>Descripci√≥n</th><th>Vida (a√±os)</th><th>Inicio</th><th>Coste (‚Ç¨)</th><th>Amort. acum. (‚Ç¨)</th><th>Valor neto (‚Ç¨)</th><th>Centro coste</th><th>Unidad org.</th><th>GMAO</th>
                        </tr>
                      </thead>
                      <tbody id="tbl-activos"></tbody>
                    </table>
                    <div id="alerts-activos" style="margin-top:10px"></div>
                  </div>
                </div>
              </section>

              <!-- ===== OPEX ===== -->
              <section id="panel-opex" class="tabpanel" role="tabpanel" aria-labelledby="tab-opex" hidden>
                <div class="kpis">
                  <div class="kpi"><div class="title">Coste / VR</div><div class="val" id="kpiCtoVR">‚Äî %</div><div class="small">Objetivo < 3%</div></div>
                  <div class="kpi"><div class="title">‚Ç¨/m√°quina (anual)</div><div class="val" id="kpiEurMaquina">‚Äî ‚Ç¨</div><div class="small">Promedio</div></div>
                  <div class="kpi"><div class="title">Prev. vs Corr.</div><div class="val" id="kpiPvC">‚Äî / ‚Äî</div><div class="small">% por ‚Ç¨</div></div>
                </div>

                <div class="grid-2" style="margin-top:12px">
                  <div>
                    <div class="toolbar" style="justify-content:space-between;margin-bottom:6px"><strong>OPEX mensual por categor√≠a</strong></div>
                    <canvas id="chOpexMes"></canvas>
                  </div>
                  <div>
                    <div class="toolbar" style="justify-content:space-between;margin-bottom:6px"><strong>Preventivo vs Correctivo</strong></div>
                    <canvas id="chPrevCorr"></canvas>
                  </div>
                </div>

                <div class="panel" style="margin-top:12px">
                  <div class="head"><span>Resumen por OT</span><input id="searchOT" placeholder="Buscar OT/m√°quina" class="btn" style="padding:8px 10px"/></div>
                  <div class="body">
                    <table>
                      <thead>
                        <tr>
                          <th>OT</th><th>M√°quina</th><th>Tipo</th><th>Repuestos (‚Ç¨)</th><th>MO interna (‚Ç¨)</th><th>MO externa (‚Ç¨)</th><th>Indirectos (‚Ç¨)</th><th>Total (‚Ç¨)</th>
                        </tr>
                      </thead>
                      <tbody id="tbl-ot"></tbody>
                    </table>
                    <div id="alerts-opex" style="margin-top:10px"></div>
                  </div>
                </div>
              </section>

              <!-- ===== CAPEX ===== -->
              <section id="panel-capex" class="tabpanel" role="tabpanel" aria-labelledby="tab-capex" hidden>
                <div class="kpis">
                  <div class="kpi"><div class="title">Presupuesto anual</div><div class="val" id="kpiBudget">‚Äî ‚Ç¨</div><div class="small">Mantenimiento</div></div>
                  <div class="kpi"><div class="title">Ejecuci√≥n vs presup. (YTD)</div><div class="val" id="kpiExec">‚Äî %</div><div class="small">Desviaci√≥n</div></div>
                  <div class="kpi"><div class="title">CAPEX comprometido</div><div class="val" id="kpiCapexComp">‚Äî ‚Ç¨</div><div class="small">A√±o en curso</div></div>
                </div>

                <div class="grid-2" style="margin-top:12px">
                  <div>
                    <div class="toolbar" style="justify-content:space-between;margin-bottom:6px"><strong>Real vs Presupuesto vs Forecast</strong></div>
                    <canvas id="chBudget"></canvas>
                  </div>
                  <div>
                    <div class="toolbar" style="justify-content:space-between;margin-bottom:6px"><strong>CAPEX por categor√≠a</strong></div>
                    <canvas id="chCapex"></canvas>
                  </div>
                </div>

                <div class="panel" style="margin-top:12px">
                  <div class="head"><span>Simulaci√≥n: reparar vs reemplazar</span></div>
                  <div class="body">
                    <div class="toolbar" style="flex-wrap:wrap;margin-bottom:8px">
                      <label>VR m√°quina (‚Ç¨) <input id="simVR" type="number" class="btn" value="85000" style="width:140px"></label>
                      <label>OPEX actual anual (‚Ç¨) <input id="simOpex" type="number" class="btn" value="6200" style="width:140px"></label>
                      <label>Ahorro si reemplazo (%) <input id="simSave" type="number" class="btn" value="22" style="width:100px"></label>
                      <label>Coste CAPEX (‚Ç¨) <input id="simCapex" type="number" class="btn" value="52000" style="width:140px"></label>
                      <button class="btn" id="simCalc">Calcular</button>
                    </div>
                    <table>
                      <thead><tr><th>Opci√≥n</th><th>Inversi√≥n (‚Ç¨)</th><th>OPEX anual (‚Ç¨)</th><th>TCO 5 a√±os (‚Ç¨)</th><th>Payback (a√±os)</th></tr></thead>
                      <tbody id="tbl-sim"></tbody>
                    </table>
                    <p class="small" id="simHint"></p>
                    <div id="alerts-capex" style="margin-top:10px"></div>
                  </div>
                </div>
              </section>

              <!-- ===== TARIFAS & GAP ===== -->
              <section id="panel-rates" class="tabpanel" role="tabpanel" aria-labelledby="tab-rates" hidden>
                <div class="kpis">
                  <div class="kpi"><div class="title">Rate/h Planasa</div><div class="val" id="kpiRatePlanasa">‚Äî ‚Ç¨/h</div><div class="small">Promedio flota</div></div>
                  <div class="kpi"><div class="title">Rate/h mercado</div><div class="val" id="kpiRateMkt">‚Äî ‚Ç¨/h</div><div class="small">Promedio flota</div></div>
                  <div class="kpi"><div class="title">GAP medio</div><div class="val" id="kpiGap">‚Äî ‚Ç¨/h</div><div class="small">Mkt ‚àí Planasa</div></div>
                </div>

                <div class="panel" style="margin-top:12px">
                  <div class="head">
                    <span>Supuestos de c√°lculo</span>
                    <div class="toolbar">
                      <label>Horas/mes <input id="hrsMes" type="number" class="btn" value="210" style="width:100px"></label>
                      <label>Incluir seguros en posesi√≥n <input id="inclIns" type="checkbox" checked></label>
                      <button id="recalcRates" class="btn">Recalcular</button>
                    </div>
                  </div>
                  <div class="body">
                    <div class="grid-2">
                      <div>
                        <div class="toolbar" style="justify-content:space-between;margin-bottom:6px"><strong>Top GAP negativo</strong></div>
                        <canvas id="chTopGap"></canvas>
                      </div>
                      <div>
                        <div class="toolbar" style="justify-content:space-between;margin-bottom:6px"><strong>Distribuci√≥n de costes (selecci√≥n)</strong></div>
                        <canvas id="chCostPie"></canvas>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="panel" style="margin-top:12px">
                  <div class="head">
                    <span>Tarifas por equipo</span>
                    <div class="toolbar"><input id="searchRates" placeholder="Buscar modelo/AF/VIN" class="btn" style="padding:8px 10px"/></div>
                  </div>
                  <div class="body">
                    <table>
                      <thead>
                        <tr>
                          <th>Modelo</th><th>N¬∫ bastidor</th><th>AF</th><th>C√≥digo partes</th><th>C√≥digo estocable</th>
                          <th class="td-right">Valor compra</th><th class="td-right">Amort. (mes)</th><th class="td-right">VNC</th><th class="td-right">Payment Asset</th>
                          <th class="td-right">Mant. C.</th><th class="td-right">Labor C.</th><th class="td-right">Fuel</th><th class="td-right">Oil</th><th class="td-right">Spare parts</th><th class="td-right">Wheels</th><th class="td-right">Insurance</th><th class="td-right">Sub Total</th>
                          <th class="td-right">PLANASA ‚Ç¨/h</th><th class="td-right">Mkt ‚Ç¨/h</th><th class="td-right">GAP ‚Ç¨/h</th>
                        </tr>
                      </thead>
                      <tbody id="tbl-rates"></tbody>
                    </table>
                    <div id="alerts-rates" style="margin-top:10px"></div>
                  </div>
                </div>
              </section>

            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script>
    // ===== Utils =====
    const EUR = n => (n||0).toLocaleString('es-ES',{style:'currency',currency:'EUR'});
    const NOW = new Date(); const year = NOW.getFullYear(); document.getElementById('yearLbl').textContent = year;
    function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }
    function yBetween(d){ return (Date.now() - new Date(d).getTime())/1000/60/60/24/365.25; }

    // ===== Datos de ejemplo (alineados con tu hoja) =====
    const assets = [
      {code:'1600-TR6R', desc:'Tractor John Deere 6R', life:10, start:'2019-03-01', cost:92000, center:'Fuente del Olmo', unit:'Operaciones', gmao:'EQ-TR-6R', vr:105000},
      {code:'1600-AT-A1', desc:'Atomizador Arrastrado A1', life:8,  start:'2021-06-15', cost:14500, center:'Fuente del Olmo', unit:'Operaciones', gmao:'EQ-AT-A1', vr:16000},
      {code:'1600-HVAC-N', desc:'HVAC Sector Norte Lab',   life:12, start:'2017-09-20', cost:38000, center:'Laboratorio Milagro', unit:'I+D', gmao:'EQ-HV-N', vr:42000},
      {code:'1600-CINT-C01',desc:'Cinta calibrado C01',     life:9,  start:'2018-02-10', cost:24000, center:'Cartaya I+D', unit:'Postcosecha', gmao:'EQ-CT-C01', vr:26000},
      {code:'1600-GEN-LAB', desc:'Generador laboratorio',   life:15, start:'2016-11-05', cost:51000, center:'Laboratorio Milagro', unit:'I+D', gmao:'EQ-GEN-LAB', vr:56000},
      {code:'1600-BMB-22',  desc:'Bomba riego 22',          life:10, start:'2020-05-12', cost:9000,  center:'Cartaya I+D', unit:'Operaciones', gmao:'EQ-BMB-22', vr:9500},
      {code:'1600-TR7M',    desc:'Tractor John Deere 7M',   life:10, start:'2022-04-01', cost:118000,center:'Fuente del Olmo', unit:'Operaciones', gmao:'EQ-TR-7M', vr:130000}
    ];
    assets.forEach(a=>{ const age=clamp(yBetween(a.start),0,a.life); a.age=age; a.deprPerYear=a.cost/a.life; a.deprAccum=Math.min(a.cost,a.deprPerYear*age); a.net=Math.max(0,a.cost-a.deprAccum); a.lifePct=Math.min(100,(age/a.life)*100); });

    // FLEET para Tarifas & GAP
    const FLEET = [
      {modelo:'Tractor JD 6930', vin:'LJ1ABC6930XYZ00001', af:'AF-TR-6930', partes:'PT-TR-6930', estocable:'EST-TR-6930',
       valorCompra:198000, amortMes:3018.78, vnc:39600, paymentAsset:0,
       mantC:520, laborC:380, fuel:950, oil:120, spareParts:260, wheels:140, insuranceCost:53.33, subTotal:2423.33,
       ratePlanasa:null, rateMkt:12.75, gap:null},
      {modelo:'Machacadora Laurini', vin:'LRNHAMMER2020X0002', af:'AF-MC-LAU', partes:'PT-MC-LAU', estocable:'EST-MC-LAU',
       valorCompra:165000, amortMes:2750, vnc:78000, paymentAsset:0,
       mantC:480, laborC:420, fuel:1180, oil:140, spareParts:360, wheels:0, insuranceCost:60, subTotal:2640,
       ratePlanasa:null, rateMkt:23.84, gap:null},
      {modelo:'Tractor JD 7M', vin:'LJ1ABC7MXYZ000003', af:'AF-TR-7M', partes:'PT-TR-7M', estocable:'EST-TR-7M',
       valorCompra:118000, amortMes:2136, vnc:72000, paymentAsset:0,
       mantC:410, laborC:320, fuel:840, oil:95, spareParts:210, wheels:110, insuranceCost:48, subTotal:1985,
       ratePlanasa:null, rateMkt:18.90, gap:null}
    ];

    // OPEX/OT/CAPEX demo
    const OTS = [
      {id:'OT-24001', eq:'Tractor John Deere 6R', type:'Preventivo', parts:320, laborInt:180, laborExt:0,   indir:60},
      {id:'OT-24002', eq:'HVAC Sector Norte',     type:'Correctivo', parts:420, laborInt:0,   laborExt:380, indir:120},
      {id:'OT-24003', eq:'Cinta calibrado C01',   type:'Correctivo', parts:190, laborInt:150, laborExt:0,   indir:40},
      {id:'OT-24004', eq:'Atomizador A1',         type:'Preventivo', parts:80,  laborInt:120, laborExt:0,   indir:20},
      {id:'OT-24005', eq:'Tractor John Deere 7M', type:'Correctivo', parts:860, laborInt:0,   laborExt:420, indir:140},
    ].map(x=>({...x,total:x.parts+x.laborInt+x.laborExt+x.indir}));

    const months = ['Ene','Feb','Mar','Abr','May','Jun','Jul','Ago','Sep','Oct','Nov','Dic'];
    const opexMonthly = months.map((m,i)=>({
      month:m,
      repuestos: 1800 + Math.round(Math.sin(i/2)*300) + (i%3===0?400:0),
      moInt: 2200 + Math.round(Math.cos(i/3)*250),
      moExt: (i%4===0?1200:800) + Math.round(Math.sin(i/1.5)*150),
      indirectos: 600 + (i%5===0?350:100)
    }));
    const BUDGET = months.map((m,i)=> 5200 + i*120);
    const ACTUAL = months.map((m,i)=> BUDGET[i] * (i<8 ? (0.98 + (i%4)/100) : 0));
    const FORE   = months.map((m,i)=> i>=8 ? BUDGET[i]* (1.03 + (i%3)/100) : 0);
    const CAPEX  = [{cat:'Reemplazo tractores',val:85000},{cat:'L√≠neas postcosecha',val:42000},{cat:'Climatizaci√≥n lab',val:28000},{cat:'Seguridad activa',val:12000}];

    // ===== Canvas helpers =====
    function clearCanvas(c){ if(!c) return {ctx:null,W:0,H:0,skip:true}; const ctx=c.getContext('2d'); const W=c.width=c.clientWidth||c.width||600; const H=c.height=c.clientHeight||c.height||300; ctx.clearRect(0,0,W,H); return {ctx,W,H,skip:false}; }
    function drawBarsVertical(id, labels, values, opts={}){ const c=document.getElementById(id); const r=clearCanvas(c); if(r.skip) return; const {ctx,W,H}=r; const M=30; const n=labels.length; const gap=(W-2*M)/Math.max(1,n); const bw=Math.max(14,gap*0.6); const max=Math.max(1,Math.max(...values)*1.2); const styles=getComputedStyle(document.documentElement); const txt=styles.getPropertyValue('--txt')||'#333'; ctx.strokeStyle='rgba(0,0,0,.2)'; ctx.beginPath(); ctx.moveTo(M,H-M); ctx.lineTo(W-M,H-M); ctx.moveTo(M,H-M); ctx.lineTo(M,M); ctx.stroke(); labels.forEach((lab,i)=>{ const v=values[i]||0; const h=(v/max)*(H-2*M); const x=M+i*gap+gap*0.2; const y=H-M-h; ctx.fillStyle=(opts.colors&&opts.colors.length)?opts.colors[i%opts.colors.length]:'#1f6f3d'; ctx.fillRect(x,y,bw,h); ctx.fillStyle=txt; ctx.font='12px system-ui'; ctx.fillText(String(lab), x, H-M+14); ctx.fillText(opts.money?EUR(v):String(v), x, y-4); }); }
    function drawBarsStacked(id, labels, stacks, keys, colors){ const c=document.getElementById(id); const r=clearCanvas(c); if(r.skip) return; const {ctx,W,H}=r; const M=30; const n=labels.length; const gap=(W-2*M)/Math.max(1,n); const bw=gap*0.7; const totals=labels.map((_,i)=>keys.reduce((s,k)=>s+(stacks[k][i]||0),0)); const max=Math.max(1,Math.max(...totals)*1.2); const txt=getComputedStyle(document.documentElement).getPropertyValue('--txt')||'#333'; ctx.strokeStyle='rgba(0,0,0,.2)'; ctx.beginPath(); ctx.moveTo(M,H-M); ctx.lineTo(W-M,H-M); ctx.moveTo(M,H-M); ctx.lineTo(M,M); ctx.stroke(); labels.forEach((lab,i)=>{ let y=H-M; const x=M+i*gap+gap*0.15; keys.forEach((k,ki)=>{ const v=stacks[k][i]||0; const h=(v/max)*(H-2*M); ctx.fillStyle=colors[ki]; ctx.fillRect(x,y-h,bw,h); y-=h; }); ctx.fillStyle=txt; ctx.font='12px system-ui'; ctx.fillText(lab, x, H-M+14); }); }
    function drawDonut(id, pairs){ const c=document.getElementById(id); const r=clearCanvas(c); if(r.skip) return; const {ctx,W,H}=r; const cx=W/2, cy=H/2, r0=Math.min(W,H)/3; const txt=getComputedStyle(document.documentElement).getPropertyValue('--txt')||'#333'; const card=getComputedStyle(document.documentElement).getPropertyValue('--card')||'#fff'; const sum=pairs.reduce((s,[_l,v])=>s+(v||0),0)||1; let a0=-Math.PI/2; const pal=['#1f6f3d','#c62828','#1e88e5','#7a5d00','#2e7d32','#9ccc65']; pairs.forEach(([lab,val],i)=>{ const a1=a0+2*Math.PI*(val/sum); ctx.beginPath(); ctx.moveTo(cx,cy); ctx.fillStyle=pal[i%pal.length]; ctx.arc(cx,cy,r0,a0,a1); ctx.fill(); a0=a1; }); ctx.beginPath(); ctx.fillStyle=card; ctx.arc(cx,cy,r0*0.56,0,Math.PI*2); ctx.fill(); ctx.fillStyle=txt; ctx.textAlign='center'; ctx.font='12px system-ui'; ctx.fillText('Distribuci√≥n', cx, cy); }

    // ===== ACTIVOS =====
    function refreshActivos(){
      document.getElementById('kpiActivos').textContent = assets.length;
      const neto=assets.reduce((s,a)=>s+a.net,0); document.getElementById('kpiValorNeto').textContent = EUR(neto);
      const edadMedia=(assets.reduce((s,a)=>s+a.age,0)/assets.length)||0; document.getElementById('kpiEdad').textContent = edadMedia.toFixed(1)+' a√±os';
      const q=(document.getElementById('searchActivos').value||'').toLowerCase();
      const rows=assets.filter(a=> (`${a.code} ${a.desc}`).toLowerCase().includes(q));
      const tb=document.getElementById('tbl-activos'); tb.innerHTML='';
      rows.forEach(a=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${a.code}</td><td>${a.desc}</td><td>${a.life}</td><td>${new Date(a.start).toLocaleDateString('es-ES')}</td><td class="td-right">${EUR(a.cost)}</td><td class="td-right">${EUR(a.deprAccum)}</td><td class="td-right">${EUR(a.net)}</td><td>${a.center}</td><td>${a.unit}</td><td>${a.gmao}</td>`; tb.appendChild(tr); });
      const byCenter={}; assets.forEach(a=>{ byCenter[a.center]=(byCenter[a.center]||0)+a.net; });
      drawBarsVertical('chActivosByCC', Object.keys(byCenter), Object.values(byCenter), {money:true});
      const top=[...assets].sort((a,b)=>b.lifePct-a.lifePct).slice(0,5); drawBarsVertical('chVidaConsumida', top.map(x=>x.desc), top.map(x=>+x.lifePct.toFixed(1)));
    }

    // ===== OPEX =====
    function refreshOpex(){
      const rep=opexMonthly.reduce((s,x)=>s+x.repuestos,0), moi=opexMonthly.reduce((s,x)=>s+x.moInt,0), moe=opexMonthly.reduce((s,x)=>s+x.moExt,0), ind=opexMonthly.reduce((s,x)=>s+x.indirectos,0);
      const opexAnual=rep+moi+moe+ind; const vrTotal=assets.reduce((s,a)=>s+a.vr,0); const ctoVR=(opexAnual/(vrTotal||1))*100;
      document.getElementById('kpiCtoVR').textContent=ctoVR.toFixed(2)+'%';
      document.getElementById('kpiEurMaquina').textContent=EUR(opexAnual/assets.length);
      const prev=OTS.filter(o=>o.type==='Preventivo').reduce((s,o)=>s+o.total,0), corr=OTS.filter(o=>o.type==='Correctivo').reduce((s,o)=>s+o.total,0);
      const pPrev=Math.round(100*prev/(prev+corr||1)); document.getElementById('kpiPvC').textContent=`${pPrev}% / ${100-pPrev}%`;
      drawBarsStacked('chOpexMes', months, {'Repuestos': opexMonthly.map(x=>x.repuestos),'MO interna': opexMonthly.map(x=>x.moInt),'MO externa': opexMonthly.map(x=>x.moExt),'Indirectos': opexMonthly.map(x=>x.indirectos)}, ['Repuestos','MO interna','MO externa','Indirectos'], ['#7a5d00','#1f6f3d','#2e7d32','#1e88e5']);
      drawDonut('chPrevCorr', [['Preventivo',prev],['Correctivo',corr]]);
      const q=(document.getElementById('searchOT').value||'').toLowerCase(); const rows=OTS.filter(o=> (`${o.id} ${o.eq} ${o.type}`).toLowerCase().includes(q));
      const tb=document.getElementById('tbl-ot'); tb.innerHTML=''; rows.forEach(o=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${o.id}</td><td>${o.eq}</td><td>${o.type}</td><td class="td-right">${EUR(o.parts)}</td><td class="td-right">${EUR(o.laborInt)}</td><td class="td-right">${EUR(o.laborExt)}</td><td class="td-right">${EUR(o.indir)}</td><td class="td-right"><strong>${EUR(o.total)}</strong></td>`; tb.appendChild(tr); });
      const wrap=document.getElementById('alerts-opex'); wrap.innerHTML=''; if(ctoVR>3){ wrap.innerHTML+=`<div class="badge b-warn">‚ö†Ô∏è OPEX/VR alto: ${ctoVR.toFixed(1)}% (objetivo <3%)</div>`; } if(corr>prev){ wrap.innerHTML+='<br/>' + `<div class="badge b-crit">‚õî Correctivo > Preventivo</div>`; } if(!wrap.innerHTML) wrap.innerHTML='<div class="badge b-ok">‚úÖ Sin alertas en OPEX.</div>';
    }

    // ===== CAPEX =====
    function refreshCapex(){
      const budgetY=BUDGET.reduce((s,x)=>s+x,0); const actualYTD=ACTUAL.reduce((s,x)=>s+(x||0),0); const forecastRem=FORE.reduce((s,x)=>s+(x||0),0);
      const execPct=(actualYTD/(budgetY||1))*100; document.getElementById('kpiBudget').textContent=EUR(budgetY); document.getElementById('kpiExec').textContent=execPct.toFixed(1)+'%';
      const capexComp=CAPEX.reduce((s,c)=>s+c.val,0); document.getElementById('kpiCapexComp').textContent=EUR(capexComp);
      drawBarsVertical('chCapex', CAPEX.map(c=>c.cat), CAPEX.map(c=>c.val), {money:true});
      // L√≠nea simple para presupuesto/real/forecast
      const c=document.getElementById('chBudget'); const r=clearCanvas(c); if(!r.skip){ const {ctx,W,H}=r; const M=30; const n=months.length; const gap=(W-2*M)/Math.max(1,n-1); const all=[...BUDGET,...ACTUAL,...FORE]; const max=Math.max(1,Math.max(...all)*1.2); const y=v=>H-M-(v/max)*(H-2*M); const x=i=>M+i*gap; ctx.strokeStyle='#7a7a7a'; ctx.beginPath(); BUDGET.forEach((v,i)=>{ if(i===0)ctx.moveTo(x(i),y(v)); else ctx.lineTo(x(i),y(v)); }); ctx.stroke(); ctx.strokeStyle='#1f6f3d'; ctx.beginPath(); ACTUAL.forEach((v,i)=>{ if(i===0)ctx.moveTo(x(i),y(v)); else ctx.lineTo(x(i),y(v)); }); ctx.stroke(); ctx.strokeStyle='#1e88e5'; ctx.beginPath(); FORE.forEach((v,i)=>{ if(i===0)ctx.moveTo(x(i),y(v)); else ctx.lineTo(x(i),y(v)); }); ctx.stroke(); }
      calcSim();
      const wrap=document.getElementById('alerts-capex'); wrap.innerHTML=''; if(execPct>75 && NOW.getMonth()<8){ wrap.innerHTML+=`<div class="badge b-warn">‚ö†Ô∏è Ejecuci√≥n alta antes de Q4</div>`; } const budgetRem=budgetY-actualYTD; if(forecastRem>budgetRem*1.1){ wrap.innerHTML+='<br/>' + `<div class="badge b-crit">‚õî Forecast supera presupuesto</div>`; } if(!wrap.innerHTML) wrap.innerHTML='<div class="badge b-ok">‚úÖ Sin alertas en CAPEX/Forecast.</div>';
    }

    // ===== Simulaci√≥n reparar vs reemplazar =====
    function calcSim(){
      const vr=Number(document.getElementById('simVR').value||0); const opex=Number(document.getElementById('simOpex').value||0); const savePct=(Number(document.getElementById('simSave').value||0)/100); const capex=Number(document.getElementById('simCapex').value||0);
      const years=5; const tcoRepair=opex*years; const tcoReplace=capex+(opex*(1-savePct))*years; const payback=capex/(opex*savePct||Infinity);
      const tb=document.getElementById('tbl-sim'); tb.innerHTML=`<tr><td>Reparar</td><td>${EUR(0)}</td><td>${EUR(opex)}</td><td>${EUR(tcoRepair)}</td><td>‚Äî</td></tr><tr><td>Reemplazar</td><td>${EUR(capex)}</td><td>${EUR(opex*(1-savePct))}</td><td>${EUR(tcoReplace)}</td><td>${isFinite(payback)?payback.toFixed(1):'‚àû'}</td></tr>`;
      document.getElementById('simHint').textContent=`Recomendaci√≥n (TCO 5 a√±os): ${tcoReplace<tcoRepair?'Reemplazar':'Reparar'}.`;
    }

    // ===== Tarifas & GAP =====
    let selectedIndex=0;
    function calcRate(it, hrsMes, includeIns){ const posesion=(+it.amortMes||0)+(+it.paymentAsset||0)+(includeIns?(+it.insuranceCost||0):0); const opex = it.subTotal!=null? (+it.subTotal||0) : ((+it.mantC||0)+(+it.laborC||0)+(+it.fuel||0)+(+it.oil||0)+(+it.spareParts||0)+(+it.wheels||0)); const rate=(posesion+opex)/Math.max(1,hrsMes); return {posesion,opex,rate}; }
    function refreshRates(){
      const hrsMes=Number(document.getElementById('hrsMes').value||210); const includeIns=document.getElementById('inclIns').checked;
      FLEET.forEach(it=>{ const {rate}=calcRate(it, hrsMes, includeIns); it.ratePlanasa=rate; it.gap=(+it.rateMkt||0)-rate; });
      const avgPlan=FLEET.reduce((s,x)=>s+(+x.ratePlanasa||0),0)/FLEET.length; const avgMkt=FLEET.reduce((s,x)=>s+(+x.rateMkt||0),0)/FLEET.length; const avgGap=FLEET.reduce((s,x)=>s+(+x.gap||0),0)/FLEET.length;
      document.getElementById('kpiRatePlanasa').textContent=avgPlan.toFixed(2)+' ‚Ç¨/h'; document.getElementById('kpiRateMkt').textContent=avgMkt.toFixed(2)+' ‚Ç¨/h'; document.getElementById('kpiGap').textContent=(avgGap>=0?'+':'')+avgGap.toFixed(2)+' ‚Ç¨/h';
      const worst=[...FLEET].sort((a,b)=>a.gap-b.gap).slice(0,5); drawBarsVertical('chTopGap', worst.map(x=>x.modelo), worst.map(x=>+x.gap.toFixed(2)), {colors:['#c62828','#c62828','#f7b500','#1e88e5','#1f6f3d']});
      const q=(document.getElementById('searchRates').value||'').toLowerCase(); const rows=FLEET.filter(x=>(`${x.modelo} ${x.vin} ${x.af} ${x.partes}`).toLowerCase().includes(q));
      const tb=document.getElementById('tbl-rates'); tb.innerHTML='';
      rows.forEach((it)=>{ const tr=document.createElement('tr'); tr.innerHTML=`<td>${it.modelo}</td><td>${it.vin}</td><td>${it.af}</td><td>${it.partes}</td><td>${it.estocable}</td><td class="td-right">${EUR(it.valorCompra)}</td><td class="td-right">${EUR(it.amortMes)}</td><td class="td-right">${EUR(it.vnc)}</td><td class="td-right">${EUR(it.paymentAsset)}</td><td class="td-right">${EUR(it.mantC)}</td><td class="td-right">${EUR(it.laborC)}</td><td class="td-right">${EUR(it.fuel)}</td><td class="td-right">${EUR(it.oil)}</td><td class="td-right">${EUR(it.spareParts)}</td><td class="td-right">${EUR(it.wheels)}</td><td class="td-right">${EUR(it.insuranceCost)}</td><td class="td-right">${EUR(it.subTotal ?? (it.mantC+it.laborC+it.fuel+it.oil+it.spareParts+it.wheels))}</td><td class="td-right">${(+it.ratePlanasa).toFixed(3)}</td><td class="td-right">${(+it.rateMkt).toFixed(3)}</td><td class="td-right ${(it.gap>=0)?'gap-pos':'gap-neg'}">${(it.gap>=0?'+':'')+(+it.gap).toFixed(3)}</td>`; tr.addEventListener('click',()=>{ selectedIndex=FLEET.indexOf(it); drawCostPie(); }); tb.appendChild(tr); });
      const neg=FLEET.filter(x=>x.gap<0).length; const wrap=document.getElementById('alerts-rates'); wrap.innerHTML = neg? `<div class="badge b-crit">‚õî GAP negativo en ${neg} equipos</div>` : `<div class="badge b-ok">‚úÖ Sin GAP negativo</div>`;
      drawCostPie();
    }
    function drawCostPie(){ const hrsMes=Number(document.getElementById('hrsMes').value||210); const includeIns=document.getElementById('inclIns').checked; const it=FLEET[selectedIndex]||FLEET[0]; const {posesion}=calcRate(it, hrsMes, includeIns); drawDonut('chCostPie', [['Posesi√≥n',posesion],['Mant.',+it.mantC||0],['MO',+it.laborC||0],['Fuel',+it.fuel||0],['Oil',+it.oil||0],['Repuestos',+it.spareParts||0],['Ruedas',+it.wheels||0]]); }

    // ===== Export =====
    function exportCSV(name, rows){ const blob=new Blob([rows.map(r=>r.join(';')).join('\n')],{type:'text/plain'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(url),500); }
    document.getElementById('exportCSV').addEventListener('click', ()=>{ const rows=[["Codigo","Descripcion","Vida","Inicio","Coste","AmortAcum","ValorNeto","Centro","Unidad","GMAO"]].concat(assets.map(a=>[a.code,a.desc,a.life,a.start,a.cost,a.deprAccum,a.net,a.center,a.unit,a.gmao])); exportCSV('activos.csv', rows); });
    document.getElementById('exportRates').addEventListener('click', ()=>{ const rows=[["Modelo","VIN","AF","Partes","Estocable","ValorCompra","AmortMes","VNC","PaymentAsset","MantC","LaborC","Fuel","Oil","SpareParts","Wheels","Insurance","SubTotal","RatePlanasa","RateMkt","GAP"]].concat(FLEET.map(x=>[x.modelo,x.vin,x.af,x.partes,x.estocable,x.valorCompra,x.amortMes,x.vnc,x.paymentAsset,x.mantC,x.laborC,x.fuel,x.oil,x.spareParts,x.wheels,x.insuranceCost,x.subTotal, (x.ratePlanasa??0).toFixed(3), (x.rateMkt??0).toFixed(3), (x.gap??0).toFixed(3)])); exportCSV('tarifas_gap.csv', rows); });

    // ===== Tabs y Tema =====
    function showTab(key){ const map={activos:['tab-activos','panel-activos'], opex:['tab-opex','panel-opex'], capex:['tab-capex','panel-capex'], rates:['tab-rates','panel-rates']}; const ids=map[key]||map['activos']; document.querySelectorAll('.tabbtn').forEach(btn=>{ const on=btn.id===ids[0]; btn.setAttribute('aria-selected',on?'true':'false'); btn.tabIndex=on?0:-1; }); document.querySelectorAll('.tabpanel').forEach(p=>p.hidden=true); document.getElementById(ids[1]).hidden=false; localStorage.setItem('fin-tabs',key); if(key==='activos') refreshActivos(); if(key==='opex') refreshOpex(); if(key==='capex') refreshCapex(); if(key==='rates') refreshRates(); }
    document.addEventListener('click', e=>{ const b=e.target.closest && e.target.closest('.tabbtn'); if(b) showTab(b.dataset.target); });


    // ===== Eventos =====
    document.getElementById('periodo').addEventListener('change', ()=>refreshOpex());
    document.getElementById('searchActivos').addEventListener('input', refreshActivos);
    document.getElementById('searchOT').addEventListener('input', refreshOpex);
    document.getElementById('simCalc').addEventListener('click', calcSim);
    document.getElementById('recalcRates').addEventListener('click', refreshRates);
    document.getElementById('searchRates').addEventListener('input', refreshRates);

    // ===== Init =====
    (function init(){
      const savedTab=localStorage.getItem('fin-tabs')||'activos'; showTab(savedTab);
      refreshActivos(); refreshOpex(); refreshCapex(); refreshRates();
    })(); 

  </script>
</body>
</html>
